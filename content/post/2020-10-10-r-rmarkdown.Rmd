---
title: "Tidy Forecasting: How to Visualize Time Series"
author: "Joon Im"
date: 2020-10-10
categories: ["R","Forecasting","Time Series"]
tags: ["R", "tidyverse", "time Series", "modeltime", "fpp2", "fpp3", "forecast","fable"]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(collapse = TRUE)
library(formatR)
library(tidyquant)
```

# 1. Set Up

### 1.1 Introduction

There are a number of forecasting packages written in R to choose from, each with their own pros and cons.

For almost a decade, the `forecast` library from the `fpp2` forecasting framework has been a major force in the time series world. However, within the last year or so an official update has been released. This new `fpp3` framework utilizes a package called `fable` that follows tidy methodology as opposed to using base R code. 

More recently, the `modeltime` library has been released and this also follows tidy methods. It has a companion package `timetk` for data manipulation and visualization which is also written by the same author.

The following is a code comparison of various time series visualizations between these frameworks: `fpp2`, `fpp3` and `timetk/modeltime`.

Before we start, keep a few things in mind:

- Only the essential code has been provided
- Non-essential code such as plot titles and themes has been excluded
- All plots utilize the Business Science ggplot theme

### 1.2 Load Libraries

```{r libraries, message=FALSE, warning=FALSE}
# Load libraries
library(fpp2)         # The OG of forecasting
library(fpp3)         # Official update to fpp2
library(timetk)       # Companion to modeltime
library(tidyverse)    # Data manipulation tools
library(cowplot)      # Add-on for arranging plots
```

# 2. Convert Time Series Objects

- The base ts object is used by `forecast` & `fpp2`
- The special `tsibble` object is used by `fable` & `fpp3`
- The standard `tibble` object is used by `timetk` & `modeltime`

### 2.1 Load Data

For the next few visualizations, we will utilize a dataset containing quarterly production values of certain commodities in Australia.

```{r load data, tidy=TRUE}
# Quarterly Australian production data as tibble
aus <- tsibbledata::aus_production %>% as_tibble()

# Check structure
aus %>% str()
```

*Always check the class of your time series data.*

### 2.2 fpp2 Method: tibble to ts

```{r}
# Convert tibble to time series object
aus_prod_ts <- ts(aus[, 2:7],  # Choose columns
                    start = c(1956, 1),  # Choose start date
                    end = c(2010, 2),    # Choose end date
                    frequency = 4)       # Choose frequency per yr
# Check it out
aus_prod_ts %>% head()
```

### 2.3 fpp3 Method: tibble/ts to tsibble

```{r}
# Convert ts to tsibble, keep wide format
aus_tsbl_wide <- aus_prod_ts %>%    # TS object
  as_tsibble(index = "index",           # Set index column
             pivot_longer = FALSE)      # Wide format

# Check it out
aus_tsbl_wide %>% head()
```

```{r}
# Convert ts to tsibble, pivot to long format
aus_tsbl_long <- aus_prod_ts %>%    # TS object
  as_tsibble(index = "index",           # Set index column
             pivot_longer = TRUE)       # Long format

# Check it out
aus_tsbl_long %>% head()
```

### 2.4 timetk Method: From tsibble/ts to tibble

```{r}
# Convert tsibble to tibble, keep wide format
aus_tbl_wide <- tsibbledata::aus_production %>% 
    tk_tbl(preserve_index = FALSE) %>%
    mutate(Quarter = as_date(as.POSIXct.Date(Quarter))) 

# Check it out
aus_tbl_wide %>% head()
```

```{r}
# Convert tsibble to tibble, pivot to long format
aus_tbl_long <- tsibbledata::aus_production %>% 
    tk_tbl(preserve_index = FALSE) %>%
    mutate(date = as_date(as.POSIXct.Date(Quarter))) %>%
    pivot_longer(cols = c("Beer":"Gas"))

# Check it out
aus_tbl_long %>% head()
```

# 3. Time Series Plots

When analyzing time series plots, look for the following patterns:

- **Trend**: A long-term increase or decrease in the data; a “changing direction”.
- **Seasonality**: A seasonal pattern of a fixed and known period. If the frequency is unchanging and associated with some aspect of the calendar, then the pattern is seasonal.
- **Cycle**: A rise and fall pattern not of a fixed frequency. If the fluctuations are not of a fixed frequency then they are cyclic.
- **Seasonal vs Cyclic**: Cyclic patterns are longer and more variable than seasonal patterns in general.

### 3.1 fpp2 Method: Plot Multiple Series On Same Axes

```{r}
# Using fpp2
aus_prod_ts %>%               # TS object
  autoplot(facets=FALSE) +    # No facetting
  ggtitle("Quarterly Production of Select Australian Commodities")
```

### 3.2 fpp3 Method: Plot Multiple Series On Same Axes

```{r warning=FALSE}
# Using fpp3
aus_tsbl_long %>%    # Data in long format
  autoplot(value)
```

### 3.3 ggplot Method: Plot Multiple Series On Same Axes

Plots on the same axes is not a feature included in `timetk` as of this writing. The `ggplot` & `fpp3` methods can be used to achieve the same result.

```{r warning=FALSE}
# Using ggplot
aus_tbl_long %>%
    ggplot(aes(date, value, group = name, color = name)) +
    geom_line()
```

---

### 3.4 fpp2 Method: Plot Multiple Series On Separate Axes

```{r fig.height=6, fig.width=8, warning=FALSE}
# Using fpp2
aus_prod_ts %>%  
  autoplot(facets=TRUE)   # With facetting
```

### 3.5 fpp3 Method: Plot Multiple Series On Separate Axes

```{r fig.height=6, fig.width=8, warning=FALSE}
# Using fpp3
aus_tsbl_long %>%
  ggplot(aes(x = index, y = value, group = key, color = key)) + 
  geom_line() + 
  theme(legend.position = "None") +         # Remove legend
  facet_grid(vars(key), scales = "free_y")  # With facetting
```

### 3.6 timetk Method: Plot Multiple Series On Separate Axes

```{r fig.height=7, fig.width=8, warning=FALSE}
# Using timetk
aus_tbl_long %>% 
    plot_time_series(
        .date_var = date,
        .value = value,
        .facet_vars = c(name), # Group by these columns
        .color_var = name, 
        .interactive = FALSE,
        .legend_show = FALSE
    )
```

# 4. Seasonal Plots

Use seasonal plots for identifying time periods in which the patterns change. The following examples will use a dataset containing the number of anti-diabetic scripts given in Australia over a period of time.

### 4.1 Load & Plot Data

```{r}

```


### 4.1 fpp2 Method: Plot Individual Seasons

```{r fig.height=6}
# Monthly plot
a1 <- fpp2::a10 %>%
  autoplot()

# Seasonal plot
a2 <- a10 %>%
  ggseasonplot(year.labels.left = TRUE,   # Add labels
               year.labels = TRUE)

# Arrangement of plots
plot_grid(a1, a2, ncol=1, rel_heights = c(1, 1.5))
```

### 4.2 fpp3 Method: Plot Individual Seasons

```{r}
# Seasonal plot
a10 %>%
  as_tsibble() %>%
  gg_season(value, labels="both")   # Add labels
```

### 4.3 ggplot Method: Plot Individual Seasons

Plots including each season is not a feature included in `timetk` as of this writing. The `ggplot` & `fpp3` methods can be used to achieve the same result.

```{r}
# Convert ts to tibble
a10_tbl <- fpp2::a10 %>%
    tk_tbl()

# New time-based features to group by
a10_tbl_add <- a10_tbl %>% 
    mutate( 
        month = factor(month(index, label = TRUE)), # x-axis
        year = factor(year(index))  # Grouped on y-axis
    )

# Seasonal plot
a10_tbl_add %>%
    ggplot(aes(x = month, y = value, 
               group = year, color = year)) + 
    geom_line() + 
    geom_text(
        data = a10_tbl_add %>% filter(month == min(month)),
        aes(label = year, x = month, y = value),
        nudge_x = -0.3) + 
    geom_text(
        data = a10_tbl_add %>% filter(month == max(month)),
        aes(label = year, x = month, y = value),
        nudge_x = 0.3) + 
    guides(color = FALSE)
```




































# Including Plots

You can also embed plots. See Figure \@ref(fig:pie) for example:

```{r pie, fig.cap='A fancy pie chart.', tidy=FALSE}
par(mar = c(0, 1, 0, 1))
pie(
  c(280, 60, 20),
  c('Sky', 'Sunny side of pyramid', 'Shady side of pyramid'),
  col = c('#0292D8', '#F7EA39', '#C4B632'),
  init.angle = -50, border = NA
)
```
